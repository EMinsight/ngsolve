#!/usr/bin/env python
# coding: utf-8

import numpy as np
import pytest
from ngsolve import *
from ngsolve import meshes


def mk_mesh():
    return meshes.MakeStructured2DMesh(nx=1,ny=1)


@pytest.fixture
def mmesh():
    return mk_mesh()

def mk_mat():
    return np.array([[-4.32733535e-01,  1.23597497e-01,  1.84953211e-01,
            4.70791688e-01,  1.12116665e+00, -1.09092520e+00,
            4.90004564e-01, -6.80054758e-01,  1.25934451e-01,
            4.84761133e-01, -9.36447700e-02, -2.37047310e-02,
            1.08003221e+00,  1.44434851e+00,  8.90610626e-01,
            -7.99030994e-01, -5.69584926e-01, -9.33523469e-01,
            2.61246098e-01, -8.91953905e-01,  6.42682779e-01,
            1.11284532e+00,  1.23990534e-01, -7.68738436e-01,
            -1.43457402e+00, -5.50376283e-02, -9.41745798e-01,
            6.14331122e-01,  3.82304276e-01, -9.77830360e-01],
           [ 4.31167342e+00, -2.54862621e+00, -1.24087228e+00,
             -2.75534849e+00, -1.62084583e+00,  2.47669034e+00,
             1.90353372e+00,  3.17930837e+00, -3.03362903e+00,
             -2.17133826e+00, -3.04748235e+00,  6.07986811e-01,
             -4.63570257e+00, -2.20176754e+00, -2.63081230e+00,
             4.48832532e-01,  3.64650231e+00,  1.47227216e+00,
             -7.69365337e-02, -7.07916992e-01, -9.63236523e-01,
             -3.83824566e+00,  1.24941422e-01,  3.32876173e-01,
             4.97594516e+00,  4.03011917e-01,  5.54190584e+00,
             -1.96915306e+00,  3.62062361e-02,  4.36112531e+00],
           [-1.36467224e+00,  7.37636358e-01,  6.77060167e-01,
            8.05541300e-01,  5.22618918e-01, -7.30076178e-01,
            -6.48891170e-01, -1.02833278e+00,  1.01045148e+00,
            6.32253383e-01,  7.41170900e-01, -4.77372355e-01,
            1.28722224e+00,  9.11732421e-01,  5.60509493e-01,
            -2.82990676e-01, -1.20323684e+00, -4.59052819e-01,
            -1.07506032e-01,  9.99848410e-02,  9.69644516e-01,
            1.42561365e+00,  2.22880816e-01, -5.36155330e-01,
            -1.66361356e+00, -2.55831306e-01, -1.86234248e+00,
            3.27151644e-01,  4.86400458e-01, -8.00003204e-01],
           [ 3.62235335e+00, -2.55952577e+00, -1.10953249e+00,
             -2.05020798e+00, -2.64816335e+00,  3.43763360e+00,
             2.16838663e+00,  4.39227362e+00, -2.87381828e+00,
             -2.42353311e+00, -2.27463228e+00,  7.54228647e-01,
             -5.40731392e+00, -2.45793006e+00, -2.74790460e+00,
             1.16141578e+00,  4.52261204e+00,  1.81399840e+00,
             -4.66605981e-01, -9.46997047e-01, -2.07010464e+00,
             -4.54263369e+00,  4.49986341e-01,  1.24248737e+00,
             4.94845986e+00, -8.92720350e-02,  5.50982371e+00,
             -2.67409671e+00, -2.67029750e-01,  4.17082623e+00],
           [-6.26799872e+00,  4.98664720e+00,  1.69210217e+00,
            4.58145788e+00,  4.39928564e+00, -5.67564688e+00,
            -4.29012924e+00, -7.27066017e+00,  5.12082956e+00,
            4.14402952e+00,  4.48614528e+00, -1.29844413e+00,
            9.19532680e+00,  4.33750907e+00,  4.29362528e+00,
            -1.80159814e+00, -7.24864090e+00, -3.71443170e+00,
            5.61638139e-01,  8.77212808e-01,  3.29354958e+00,
            7.79806479e+00,  3.58028161e-01, -1.65960939e+00,
            -8.45105692e+00, -6.24584553e-01, -1.02271849e+01,
            4.63021922e+00,  9.32788447e-02, -6.87969433e+00],
           [ 5.64970127e+00, -3.27400855e+00, -1.65182415e+00,
             -3.43191379e+00, -3.34645568e+00,  5.10644356e+00,
             3.12786342e+00,  5.63743126e+00, -4.04835511e+00,
             -3.33047274e+00, -3.55850115e+00,  7.08111933e-01,
             -8.23243970e+00, -3.85804105e+00, -4.10360105e+00,
             1.88841063e+00,  5.38533349e+00,  2.89954591e+00,
             -4.98914170e-01, -5.87820539e-01, -2.81844974e+00,
             -6.23364108e+00,  1.44493923e-01,  2.18806473e+00,
             7.15390865e+00,  1.84292143e-01,  8.08576419e+00,
             -3.64030771e+00, -5.68656732e-01,  5.94526781e+00],
           [-1.28264935e+01,  7.78703353e+00,  3.79365573e+00,
            9.66988187e+00,  8.85917733e+00, -1.18799809e+01,
            -7.23165609e+00, -1.39992473e+01,  8.80389429e+00,
            9.06585853e+00,  8.22336052e+00, -1.83803887e+00,
            1.99274063e+01,  1.00804763e+01,  9.62665747e+00,
            -5.48180926e+00, -1.40516962e+01, -6.24509497e+00,
            2.32396920e-01,  1.12041641e+00,  7.43970517e+00,
            1.53579788e+01,  3.67669905e-02, -5.65059850e+00,
            -1.74399042e+01, -3.53827815e-01, -1.98023719e+01,
            9.52989970e+00,  9.35073781e-01, -1.60315238e+01],
           [ 1.40218314e+00, -3.87967580e-01, -5.03058087e-01,
             -7.56470232e-01, -7.13455917e-01,  1.36604042e+00,
             -1.79444876e-01,  7.80102563e-01, -3.94620537e-01,
             -9.09407286e-01, -5.73587664e-01,  5.17581003e-02,
             -2.14655734e+00, -9.10369056e-01, -1.08544365e+00,
             7.59357972e-01,  1.27748233e+00,  2.46684009e-01,
             2.52880432e-01, -1.32939504e-01, -5.69526665e-01,
             -9.55687009e-01,  1.58737571e-01,  1.05453447e+00,
             1.65811004e+00, -2.02308052e-01,  1.33559281e+00,
             -7.90910915e-01, -2.65290182e-01,  1.68377503e+00],
           [-5.89074085e+00,  3.22733855e+00,  1.70806404e+00,
            4.50677899e+00,  3.64211396e+00, -5.20694664e+00,
            -2.59429818e+00, -5.40380333e+00,  3.97862654e+00,
            3.92157264e+00,  3.53118569e+00, -1.04972316e+00,
            8.89285727e+00,  4.80556344e+00,  3.94260631e+00,
            -2.40112384e+00, -6.04633423e+00, -2.08782819e+00,
            -7.45454871e-01,  4.67798282e-01,  3.06501477e+00,
            6.31574604e+00,  2.16830053e-01, -2.21744956e+00,
            -7.16327396e+00, -2.60900070e-01, -8.99588825e+00,
            3.58879757e+00,  1.90375180e-01, -7.11815361e+00],
           [ 5.92481300e+00, -3.25611522e+00, -1.57743556e+00,
             -3.71784212e+00, -3.65175185e+00,  4.14933797e+00,
             2.78298870e+00,  5.41835043e+00, -3.92523525e+00,
             -3.76002199e+00, -3.64111628e+00,  7.96699191e-01,
             -7.88680350e+00, -3.19932549e+00, -3.92513408e+00,
             1.33936988e+00,  5.66584661e+00,  2.47159470e+00,
             8.59736099e-02, -5.80112281e-01, -2.22035054e+00,
             -6.33403739e+00,  2.41252046e-01,  1.64606618e+00,
             6.60610866e+00,  4.69300147e-01,  8.19090612e+00,
             -3.80060198e+00,  1.41988808e-01,  6.37271485e+00],
           [-8.45830106e+00,  5.16072115e+00,  2.27362532e+00,
            5.24046759e+00,  4.42320701e+00, -6.12812135e+00,
            -4.33743912e+00, -8.27460054e+00,  6.21908875e+00,
            5.27396810e+00,  5.70049254e+00, -1.53259523e+00,
            1.13935259e+01,  5.08901790e+00,  5.21436712e+00,
            -1.99978238e+00, -8.51279924e+00, -3.58699915e+00,
            -4.54072880e-01,  1.38305559e+00,  3.26335304e+00,
            8.68486088e+00, -8.88993659e-02, -1.79330818e+00,
            -9.39019711e+00, -7.64037497e-02, -1.19858962e+01,
            5.31317698e+00,  8.69397637e-02, -9.34581113e+00],
           [ 2.16999342e+00, -1.31246223e+00, -6.67686662e-01,
             -1.30533700e+00, -5.70218791e-01,  7.19041737e-01,
             1.28221138e+00,  1.79480839e+00, -2.07537479e+00,
             -9.36341834e-01, -1.82589826e+00,  6.14001903e-01,
             -2.09021117e+00, -5.72801566e-01, -1.16834394e+00,
             2.27599665e-01,  2.27943212e+00,  5.59344481e-01,
             2.27286361e-01, -8.42416987e-01, -5.29047162e-01,
             -2.04803559e+00,  1.30764452e-01, -4.61237739e-02,
             1.98614986e+00, -2.76428500e-01,  3.11563548e+00,
             -9.04343208e-01,  2.34710167e-01,  2.15133405e+00],
           [-4.03858309e-01,  3.55923762e-01, -6.12700738e-02,
            -1.87730036e-01, -1.02847338e-01, -1.62398355e-02,
            1.09119016e-02,  5.70945944e-02, -4.40571733e-03,
            -9.21514924e-02,  1.26094972e-01,  5.79427805e-01,
            3.67976821e-01, -3.01951930e-01,  7.53534754e-01,
            3.26074892e-01, -5.74248600e-01, -4.39348306e-01,
            2.19318935e-01,  3.90795440e-01, -4.16791843e-01,
            4.02519127e-01, -3.44682922e-01,  6.06930496e-02,
            -3.12120065e-02,  1.60790346e-01, -2.72816457e-01,
            5.57756317e-01, -3.09655445e-01, -7.75164991e-01],
           [ 4.07839946e+00, -2.81207593e+00, -7.45367401e-01,
             -3.24603003e+00, -2.91676356e+00,  3.61227927e+00,
             2.61102956e+00,  4.68377628e+00, -2.61381298e+00,
             -3.11342770e+00, -2.71640589e+00,  1.73077419e-01,
             -6.44668744e+00, -3.12291910e+00, -3.01235927e+00,
             1.99864216e+00,  5.02745306e+00,  2.07832347e+00,
             -3.31682013e-01, -4.33264786e-01, -2.23218076e+00,
             -5.07186772e+00,  6.96941487e-02,  1.45051046e+00,
             5.16372363e+00,  1.69534021e-01,  6.73653981e+00,
             -3.85559637e+00, -3.03591136e-02,  5.69544912e+00],
           [-2.95756261e+00,  1.70067215e+00,  1.28156690e+00,
            2.13455371e+00,  1.76714446e+00, -2.68137670e+00,
            -5.54758079e-01, -2.55786765e+00,  1.68229506e+00,
            2.26990788e+00,  1.54728860e+00, -7.53785929e-01,
            4.29677722e+00,  2.36938151e+00,  2.04084530e+00,
            -9.82316619e-01, -2.43757708e+00, -9.28422437e-01,
            -4.97455764e-01, -4.76900831e-01,  1.53284604e+00,
            2.57781172e+00,  1.58679605e-01, -1.39191988e+00,
            -3.47202095e+00, -3.80805374e-01, -4.18625108e+00,
            1.55718193e+00,  3.29681438e-01, -3.57807753e+00],
           [-8.78158727e+00,  4.98936430e+00,  2.69274243e+00,
            5.57507008e+00,  5.38970160e+00, -6.95115480e+00,
            -3.20333486e+00, -7.82379102e+00,  5.71375114e+00,
            5.41820036e+00,  5.07729003e+00, -1.46856584e+00,
            1.18405519e+01,  6.08765962e+00,  5.87347195e+00,
            -2.89245269e+00, -8.04149708e+00, -3.83486708e+00,
            -1.22533796e-01, -9.99359839e-02,  4.20873017e+00,
            9.05134575e+00,  4.54998468e-01, -2.79496019e+00,
            -1.03575707e+01, -1.08179868e+00, -1.18923782e+01,
            5.03115627e+00,  3.36398729e-01, -9.57258829e+00],
           [ 1.32587069e+01, -8.21660919e+00, -3.75215561e+00,
             -9.23974724e+00, -8.24912026e+00,  1.12292095e+01,
             6.48421706e+00,  1.35740959e+01, -9.27683972e+00,
             -8.44459018e+00, -8.27331179e+00,  2.41712896e+00,
             -1.88635373e+01, -9.73187958e+00, -9.33601457e+00,
             4.55712669e+00,  1.36846478e+01,  6.25360107e+00,
             -5.58604259e-02, -1.19268985e+00, -6.39219967e+00,
             -1.49142831e+01, -5.05600631e-01,  4.30739188e+00,
             1.64107046e+01,  8.68621117e-01,  1.98000210e+01,
             -9.23684411e+00, -4.15348913e-01,  1.53024276e+01],
           [ 2.08574433e+00, -9.30361910e-01, -1.12321696e+00,
             -1.83980585e+00, -1.60466206e+00,  2.25486765e+00,
             5.61760833e-01,  2.29737340e+00, -1.47557183e+00,
             -1.78951384e+00, -1.10661480e+00,  5.44783636e-01,
             -4.04638763e+00, -2.07281470e+00, -1.58405904e+00,
             1.13290422e+00,  2.43422844e+00,  8.41421948e-01,
             4.19900300e-01,  2.05814683e-01, -1.62565358e+00,
             -2.38075996e+00, -4.50483379e-01,  1.83177825e+00,
             3.00464192e+00,  3.51505377e-01,  3.54520674e+00,
             -1.01884903e+00, -5.91715783e-01,  2.93078162e+00],
           [ 7.54807929e-01, -5.14447155e-01, -4.36772756e-01,
             -3.22219736e-01, -7.36489563e-02, -6.46183612e-02,
             -3.44101198e-01, -8.08557338e-02, -1.41132613e-02,
             -2.97156622e-01, -4.51900926e-01,  4.83896101e-02,
             -7.17708841e-01, -3.41715934e-01,  1.57769988e-01,
             -4.46209261e-01, -4.48411617e-01,  2.16479106e-01,
             7.18289628e-01,  5.53080041e-01,  1.45536124e-01,
             3.33048672e-01, -1.61433460e-01, -2.28312245e-01,
             2.59730632e-01,  4.96748896e-01,  6.32421781e-01,
             1.28724030e-01,  3.75519883e-01,  2.73951403e-01],
           [ 3.97169653e+00, -2.69045856e+00, -5.45970870e-01,
             -2.54382141e+00, -2.44522277e+00,  2.72626839e+00,
             1.76502900e+00,  3.56834871e+00, -2.24578582e+00,
             -1.99596350e+00, -2.25764015e+00,  2.00523526e-01,
             -4.58712033e+00, -2.21397991e+00, -2.91268160e+00,
             4.87939154e-01,  3.60233600e+00,  2.55860863e+00,
             -3.39794183e-01,  1.04711116e-02, -1.31680877e+00,
             -4.24797999e+00, -1.26158720e-01,  1.24324742e-01,
             4.56121898e+00,  3.86659743e-01,  5.46250140e+00,
             -2.58832673e+00,  4.19309073e-02,  3.86502724e+00],
           [-2.05373588e+00,  1.20469946e+00,  6.73325644e-01,
            1.28580305e+00,  8.90393606e-01, -7.90395761e-01,
            -1.36593065e+00, -1.52851940e+00,  1.43552247e+00,
            1.21147007e+00,  1.58743174e+00, -3.34712724e-01,
            2.12561293e+00,  4.28327518e-01,  1.30640806e+00,
            1.18341749e-02, -1.95824822e+00, -3.83547542e-01,
            -5.68374138e-02,  9.57678016e-01, -7.21294449e-02,
            1.40733201e+00, -3.23225273e-02,  3.16635184e-01,
            -2.22494159e+00, -4.41908488e-02, -2.89182272e+00,
            1.52937943e+00, -2.07601027e-01, -2.60214187e+00],
           [ 6.64496603e+00, -4.29007343e+00, -1.71277051e+00,
             -4.31398498e+00, -4.43545698e+00,  5.67145557e+00,
             3.89756376e+00,  7.14551751e+00, -5.02032980e+00,
             -4.62301347e+00, -4.32206406e+00,  1.19187346e+00,
             -9.88642611e+00, -4.11020665e+00, -4.96839467e+00,
             2.38869891e+00,  7.44142195e+00,  3.59431815e+00,
             -2.37291272e-01, -1.34423668e+00, -3.19352839e+00,
             -7.87226746e+00,  2.68669688e-01,  1.80363886e+00,
             8.41140231e+00,  3.22097483e-01,  9.95592875e+00,
             -5.21190366e+00, -3.40557947e-01,  8.24095119e+00],
           [ 4.89622273e+00, -2.93412541e+00, -1.60384947e+00,
             -3.81841932e+00, -3.47173224e+00,  5.07252756e+00,
             2.44859822e+00,  4.96356896e+00, -3.11144171e+00,
             -3.21091371e+00, -3.09078470e+00,  8.34856901e-01,
             -7.44695431e+00, -4.25178158e+00, -3.78931367e+00,
             1.77392645e+00,  5.18726159e+00,  2.85663374e+00,
             -3.81433911e-01, -1.55522835e-01, -2.84085628e+00,
             -5.80612246e+00, -3.09280878e-01,  2.07716017e+00,
             6.56308038e+00,  5.44676874e-01,  7.44700235e+00,
             -3.57318799e+00, -2.65254583e-01,  6.19583888e+00],
           [ 3.28472044e+00, -1.89912547e+00, -1.00700310e+00,
             -2.33721531e+00, -2.39727455e+00,  3.00060088e+00,
             1.35492132e+00,  3.10673509e+00, -2.11505287e+00,
             -2.74488395e+00, -1.91747179e+00,  8.76040375e-01,
             -4.80886322e+00, -2.95755957e+00, -2.06457840e+00,
             1.64512930e+00,  2.83323278e+00,  1.21937925e+00,
             3.15503100e-01,  2.67669811e-01, -2.01866911e+00,
             -3.62680161e+00, -6.73585057e-01,  1.71524242e+00,
             4.41720184e+00,  2.43897515e-01,  4.99990675e+00,
             -1.62496823e+00, -3.05637023e-01,  3.95481488e+00],
           [-6.14698060e+00,  3.94085647e+00,  1.20235162e+00,
            3.61724680e+00,  3.44926463e+00, -4.36139876e+00,
            -3.39140763e+00, -5.67262085e+00,  3.82139202e+00,
            3.72102388e+00,  4.48529782e+00, -6.41806519e-01,
            7.92842976e+00,  2.96336254e+00,  4.67993055e+00,
            -8.76306920e-01, -5.98132074e+00, -3.26192829e+00,
            4.57761077e-01,  1.39103144e+00,  1.74081517e+00,
            6.08388769e+00, -4.49846693e-01, -6.69316277e-01,
            -6.87841177e+00, -6.50155153e-01, -8.22698335e+00,
            4.38553882e+00, -5.08894523e-01, -6.58186160e+00],
           [-1.31677693e+00,  2.02451746e-01, -2.46603982e-01,
            1.44714131e-01,  3.26327550e-04, -2.77646225e-01,
            -3.41093867e-01, -3.80488626e-01,  9.31804947e-01,
            3.00615283e-01,  1.06343021e+00, -3.64922701e-01,
            1.19025215e+00,  7.38933223e-02,  3.37186413e-01,
            2.03775055e-01, -6.57594256e-01,  8.48688629e-02,
            -2.03909528e-01,  3.93945634e-01,  2.28838592e-01,
            9.91774096e-01, -1.45521832e-02,  1.51250285e-01,
            -5.17610866e-01,  5.31457146e-02, -1.25910206e+00,
            1.21141945e-01, -2.37540515e-01, -7.45934256e-01],
           [ 2.88078717e-01, -3.92628678e-01, -2.71586592e-01,
             -1.35530564e-01, -2.22602317e-03, -1.48201239e-03,
             1.32043739e-01,  1.71909695e-01, -2.44805479e-01,
             -4.54635273e-02, -2.58187870e-01,  3.59162961e-01,
             -3.41979952e-01, -2.96684655e-01, -1.01452480e-01,
             2.97074395e-02,  5.41848430e-01,  1.54496344e-01,
             2.55998123e-01,  2.72952582e-01,  8.70711371e-03,
             -6.39044047e-01,  2.22429379e-02, -2.56822045e-01,
             1.94074252e-01,  3.37094914e-02,  3.80285281e-01,
             1.59385915e-01, -1.69520101e-01,  1.75794335e-01],
           [ 1.28611608e+00, -4.95261740e-01, -4.46675348e-01,
             -7.41385580e-01, -4.97328716e-01,  1.39510577e+00,
             6.80180303e-01,  1.34657829e+00, -1.00079111e+00,
             -1.12298661e+00, -1.10823225e+00,  1.90126338e-01,
             -2.00668234e+00, -1.05368133e+00, -1.11380205e+00,
             6.34949086e-01,  1.64942484e+00,  5.35760259e-02,
             4.05334568e-01, -5.11700189e-01, -5.51076201e-01,
             -1.35617472e+00,  1.90643380e-01,  3.91871530e-01,
             1.66633184e+00, -2.67784478e-01,  2.10203906e+00,
             -1.21589404e+00,  1.32216985e-01,  1.95215499e+00],
           [-6.26637196e+00,  3.84209560e+00,  2.44150758e+00,
            4.23664896e+00,  4.16577682e+00, -5.41598390e+00,
            -2.95843722e+00, -6.49635710e+00,  4.47665719e+00,
            3.90702662e+00,  4.15736542e+00, -1.03324835e+00,
            8.78509758e+00,  4.19669303e+00,  4.55174142e+00,
            -1.77913518e+00, -6.57893068e+00, -3.19045035e+00,
            -1.30243148e-01,  8.37185132e-01,  2.70284935e+00,
            7.20522964e+00, -7.93234446e-02, -1.96593221e+00,
            -7.84146269e+00, -5.30737960e-01, -9.37706462e+00,
            4.34178476e+00,  5.43616710e-01, -7.55305211e+00],
           [ 8.89894076e-01, -4.39309017e-01, -5.31015541e-01,
             -5.67517933e-01, -6.06324672e-01,  6.63691691e-01,
             2.45865087e-01,  5.21254739e-01, -7.25159233e-01,
             -2.73150364e-01, -8.07316349e-01,  2.42144296e-01,
             -1.09337640e+00, -6.54828671e-01, -6.45261032e-01,
             -3.12325613e-01,  4.36734983e-01,  1.70665793e-01,
             5.35626701e-01,  1.29513978e-02, -3.12275042e-01,
             -3.60067945e-01, -1.90189667e-01,  5.55290473e-01,
             9.73084840e-01,  4.68904825e-01,  1.26153804e+00,
             -3.36843130e-01, -8.59961507e-02,  1.19982759e+00]])

@pytest.fixture
def mat():
    return mk_mat()


@pytest.mark.parametrize("D", (1, 2, 3, 10, 20))
def test_inverse(mmesh, mat, D):
    X0 = mmesh(0, 0)
    cf = CF(tuple(mat[:D, :D].flatten().tolist()), dims=((D, D)))
    inv_val = Inv(cf)(X0)
    assert np.max(np.abs(np.array(inv_val) - np.linalg.inv(mat[:D, :D]).flatten())) < (1e-12 * D**2)


if __name__ == "__main__":
    _mesh = mk_mesh()
    _mat = mk_mat()
    test_inverse(_mesh, _mat, 20)